<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="utf-8" />
  <style>
      fits-demo {
          display: flex;
          flex-direction: column;
      }
  </style>
</head>
<body>
<script type="module">
    import { html, LitElement } from 'lit';
    import '../src/fits-img.js';
    import '../src/fits-keogram.js';

    export class FITSDemo extends LitElement {
        static properties = {
            _src: { type: String },
            _stretch: { type: String },
            _colormap: { type: String },
            _scaleCutoff: { type: Number },
            _wavelength: { type: String }
        };

        constructor() {
            super();
            this._files = {}
            this._stretch = 'linear';
            this._colormap = 'gray';
            this._scaleCutoff = 0.999;
            this._wavelength = '5577';
            this._stations = new Set();
        }

        async connectedCallback() {
          super.connectedCallback();
          await this.loadData();
        }

        async loadData() {
          await new Promise((r) => setTimeout(r, 0));
          const evening = await fetch('api/2022/03/30/cube.json');
          const morning = await fetch('api/2022/03/31/cube.json');
          let eveningCubes = await evening.json();
          let morningCubes = await morning.json();

          eveningCubes = eveningCubes.filter(cube => Number(cube.split('/').slice(-2,-1)) >= 12)
          morningCubes = morningCubes.filter(cube => Number(cube.split('/').slice(-2,-1)) <= 12)

          let cubes = eveningCubes.concat(morningCubes);

          cubes = cubes.filter(cube => !cube.includes('-10'));
          cubes.forEach(cube => {
            const station = cube.slice(-16, -15);
            const wavelength = cube.slice(-14, -10);
            this._files[wavelength] = this._files[wavelength] || {};
            this._files[wavelength][station] = this._files[wavelength][station] || [];
            this._files[wavelength][station].push(cube);
            this._stations.add(station);
          })
          this.requestUpdate();
        }

        _changeStretch(event) {
            this._stretch = event.target.value;
        }

        _changeColormap(event) {
            this._colormap = event.target.value;
        }

        _changeScaleCutoff(event) {
            this._scaleCutoff = event.target.value;
        }

        _changeWavelength(event) {
          this._wavelength = event.target.value;
        }

        images(station) {
          if(!this._files || !this._files[this._wavelength]) {
            return html``;
          }
          station = station.toUpperCase();
          return this._files[this._wavelength][station].map(cube => {
            const filename = cube.slice(2);
            const dateDirs = filename.slice(3).split('T')[0].replaceAll('-', '/')
            return html`<fits-img
              src="files/${dateDirs}/${filename}"
              ></fits-img>`;
          })
        }

        render() {
            const stations = Array.from(this._stations).map(key => {
              return html`
                <figure>
                  <figcaption>${key}</figcaption>
                  <fits-keogram stretch=${this._stretch}
                    colormap=${this._colormap}
                    scale-cutoff="${this._scaleCutoff}">
                    ${this.images(key)}
                  </fits-keogram>
                </figure>
              `
            })

            return html`
            <h1>&lt;fits-keogram&gt; interactive demo</h1>
            <p><a href="index.html">Full size image interactive demo</a></p>
            <p>
            <label
              >Stretch
              <select @change="${this._changeStretch}">
                <option>linear</option>
                <option>sqrt</option>
                <option>cuberoot</option>
                <option>log</option>
                <option>sqrtlog</option>
                <option>loglog</option>
              </select></label
            >
            <label
              >Colormap
              <select @change="${this._changeColormap}">
                <option>gray</option>
                <option>heat</option>
                <option>A</option>
                <option>B</option>
              </select></label
            >
            <label
              >Scale cutoff
              <input
                type="number"
                @change="${this._changeScaleCutoff}"
                value="${this._scaleCutoff}"
                step="0.001"
                min="0"
                max="1"
              />
            </label>
            <label>
              Wavelength (Ã…)
              <select @change="${this._changeWavelength}" value="${this._wavelength}">
                <option>4278</option>
                <option selected>5577</option>
                <option>6300</option>
              </select>
            </label>
            </p>
            <div>
              ${stations}
            </div>
            `;
        }
    }
    customElements.define('fits-demo', FITSDemo);
</script>
<fits-demo></fits-demo>
</body>
</html>

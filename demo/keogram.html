<!DOCTYPE html>
<html lang='en-GB'>
<head>
  <meta charset='utf-8' />
  <link rel='stylesheet' href='https://www.irf.se/branding/irf.css'>
</head>
<body>
<label class='color-scheme'>
  <input type='checkbox'> Darkmode
</label>
<h1>ALIS_4D quicklook</h1>
<script type='module'>
  import { css, html, LitElement } from 'lit';
  import '../src/fits-img.js';
  import '../src/fits-keogram.js';

  const urlDateFormat = (date) => {
    return date.toISOString().slice(0, 10);
  };

  export class FITSDemo extends LitElement {

    constructor() {
      super();
      this._files = {};
      this._stretch = 'sqrt';
      this._colormap = 'B';
      this._scaleCutoff = 0.999;
      this._wavelength = '5577';
      this._stations = new Set();
      const dateParam = new URLSearchParams(window.location.search).get('date');
      const yesterday = new Date().setDate(new Date().getDate() - 1);
      this._date = dateParam || urlDateFormat(yesterday);
    }

    static styles = css`
      figure {
        display: flex;
        background-color: black;
        margin-left: 0;
        height: 130px;
      }

      figcaption {
        font-size: 2em;
        display: block;
        vertical-align: center;
        color: white;
        padding: .5em;
      }

      input, select {
        margin-right: .5em;
      }
    `;

    async connectedCallback() {
      super.connectedCallback();
      await this.loadData();
    }

    async loadData() {
      await new Promise((r) => setTimeout(r, 0));
      let tomorrow = new Date(Date.parse(this._date));
      tomorrow.setDate(tomorrow.getDate() + 1)
      const eveningDate = this._date.replaceAll('-', '/');
      const morningDate = urlDateFormat(tomorrow).replaceAll('-', '/');

      const eveningResponse = await fetch(`api/${eveningDate}/cube.json`);
      const morningResponse = await fetch(`api/${morningDate}/cube.json`);
      let eveningCubes = await eveningResponse.json();
      let morningCubes = await morningResponse.json();

      eveningCubes = eveningCubes.filter(cube => Number(cube.split('/').slice(-2, -1)) >= 12);
      morningCubes = morningCubes.filter(cube => Number(cube.split('/').slice(-2, -1)) < 12);

      let cubes = eveningCubes.concat(morningCubes);

      cubes = cubes.filter(cube => !cube.includes('-10'));
      cubes.forEach(cube => {
        const station = cube.slice(-16, -15);
        const wavelength = cube.slice(-14, -10);
        this._files[wavelength] = this._files[wavelength] || {};
        this._files[wavelength][station] = this._files[wavelength][station] || [];
        this._files[wavelength][station].push(cube);
        this._stations.add(station);
      });
      this.requestUpdate();
    }



    _changeDate(event) {
      const urlParams = new URLSearchParams(window.location.search);
      const changedDate = urlDateFormat(new Date(event.target.value));
      urlParams.set("date", changedDate);
      window.location.search = urlParams;
    }

    _changeStretch(event) {
      this._stretch = event.target.value;
    }

    _changeColormap(event) {
      this._colormap = event.target.value;
    }

    _changeScaleCutoff(event) {
      this._scaleCutoff = event.target.value;
    }

    _changeWavelength(event) {
      this._wavelength = event.target.value;
    }

    images(station) {
      if (!this._files || !this._files[this._wavelength]) {
        return html``;
      }
      station = station.toUpperCase();
      return this._files[this._wavelength][station].map(cube => {
        const filename = cube.slice(2);
        const dateDirs = filename.slice(3).split('T')[0].replaceAll('-', '/');
        return html`<fits-img
              src='files/${dateDirs}/${filename}'
              ></fits-img>`;
      });
    }

    render() {
      const stations = Array.from(this._stations).map(key => {
        return html`
                <figure>
                  <figcaption>${key}</figcaption>
                  <fits-keogram stretch='${this._stretch}'
                    colormap='${this._colormap}'
                    scale-cutoff='${this._scaleCutoff}'>
                    ${this.images(key)}
                  </fits-keogram>
                </figure>
              `;
      });

      return html`
            <p>
            <label>
              Data of night beginning on
              <input type='date' @change='${this._changeDate}' .value='${this._date}'>
            </label>
            <label
              >Stretch
              <select @change='${this._changeStretch}'>
                <option>linear</option>
                <option selected>sqrt</option>
                <option>cuberoot</option>
                <option>log</option>
                <option>sqrtlog</option>
                <option>loglog</option>
              </select></label
            >
            <label
              >Colormap
              <select @change='${this._changeColormap}'>
                <option>gray</option>
                <option>heat</option>
                <option>A</option>
                <option selected>B</option>
              </select></label
            >
            <label
              >Scale cutoff
              <input
                type='number'
                @change='${this._changeScaleCutoff}'
                .value='${this._scaleCutoff}'
                step='0.001'
                min='0'
                max='1'
              />
            </label>
            <label>
              Wavelength (Ã…)
              <select @change='${this._changeWavelength}' value='${this._wavelength}'>
                <option>4278</option>
                <option selected>5577</option>
                <option>6300</option>
              </select>
            </label>
            </p>
            <div>
              ${stations}
            </div>
            `;
    }
  }

  FITSDemo.properties = {
    _src: { type: String },
    _stretch: { type: String },
    _colormap: { type: String },
    _scaleCutoff: { type: Number },
    _wavelength: { type: String }
  };

  customElements.define('fits-demo', FITSDemo);
</script>
<script src='https://www.irf.se/branding/irf-toggle-color-scheme.js'></script>
<fits-demo></fits-demo>
</body>
</html>
